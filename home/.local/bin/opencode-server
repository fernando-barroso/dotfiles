#!/usr/bin/env bash
set -euo pipefail

# Wrapper for opencode headless server.
# - Sets PATH for launchd (which has a minimal env)
# - Reads password from file (avoids process-list leak)
# - Binds to Tailscale interface only

export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

PW_FILE="$HOME/.config/opencode/credentials/server_password"

if [[ ! -f "$PW_FILE" ]]; then
    echo "error: password file not found: $PW_FILE" >&2
    exit 1
fi

export OPENCODE_SERVER_PASSWORD
OPENCODE_SERVER_PASSWORD=$(<"$PW_FILE")

# Resolve Tailscale IP: brew CLI or Mac app
if command -v tailscale &>/dev/null; then
    TS_CLI=tailscale
elif [[ -x /Applications/Tailscale.app/Contents/MacOS/Tailscale ]]; then
    TS_CLI=/Applications/Tailscale.app/Contents/MacOS/Tailscale
else
    echo "error: tailscale not found" >&2
    exit 1
fi

HOSTNAME=$("$TS_CLI" ip -4 2>/dev/null) || {
    echo "error: failed to resolve tailscale IPv4 address" >&2
    exit 1
}

exec opencode serve --hostname "$HOSTNAME" --port 4096
