# Architecture

## Key Design Patterns

- **Stow-based symlinks**: all configs live in `home/`, mirroring the home directory structure. A single command (`stow -d ~/dotfiles -t ~ home`) symlinks everything into `~`. The `dot stow` wrapper uses `--restow` to cleanly handle updates.

- **XDG-compliant paths**: configs use `~/.config/` where the tool natively supports it. Git (`~/.config/git/`), tmux (`~/.config/tmux/`), ripgrep (`~/.config/ripgrep/`), Ghostty (`~/.config/ghostty/`), and opencode (`~/.config/opencode/`) all follow XDG conventions. Files that cannot move to XDG (`.zshrc`, `.p10k.zsh`, `.zsh_history`) remain at `~`.

- **Separate Brewfiles**: `packages/Brewfile` contains everything shared across laptop and server (CLI tools, shell plugins, dev runtimes). `packages/Brewfile.server` adds only server-specific packages (Docker, Tailscale).

- **Casks only install on non-server init**: GUI apps (Discord, Chrome, Obsidian, Raycast, Slack, Spotify, etc.) are listed as casks in the shared Brewfile. On the headless Mac Mini, `dot init --server` skips cask installation since GUI apps are irrelevant.

- **Platform detection**: Homebrew path differs on Apple Silicon (`/opt/homebrew`) vs Intel (`/usr/local`). The `.zshrc` conditionally evaluates `/opt/homebrew/bin/brew shellenv` for Apple Silicon Macs.

- **dot CLI orchestrates setup**: `dot init` runs a deterministic bootstrap sequence: install Homebrew, `brew bundle` packages, stow configs, clone TPM, install global npm packages (repomix via pnpm). The `--server` flag additionally disables sleep, enables SSH remote login, and disables Spotlight indexing.

- **No plugin manager for zsh**: all shell plugins (zsh-autosuggestions, zsh-syntax-highlighting, powerlevel10k) are installed via Homebrew and sourced directly. No oh-my-zsh, zinit, or similar framework.

## Important Relationships

- **`.zshrc` loading order**: p10k instant prompt first (must be at top of file), then Homebrew shellenv, then powerlevel10k theme + p10k config, then navigation (zoxide, fzf), then direnv, then plugins (autosuggestions, syntax-highlighting last per its docs), then env vars, PATH, aliases, and history config.

- **direnv auto-loads `.envrc` per project directory**: the `direnv` hook is initialized in `.zshrc`, so entering a directory with an `.envrc` automatically loads/unloads environment variables.

- **`RIPGREP_CONFIG_PATH` env var** points ripgrep to `~/.config/ripgrep/config`. Without this variable, ripgrep does not read any config file by default.

- **tmux-resurrect + tmux-continuum auto-save/restore sessions**: resurrect persists tmux sessions across restarts, and continuum (`@continuum-restore 'on'`) automatically restores sessions when tmux starts. This is critical for the headless server where tmux sessions must survive reboots.

- **`~/.local/bin/` is in PATH** for custom scripts. The directory is scaffolded with a `.gitkeep` and prepended to `$PATH` in `.zshrc`.

- **Git uses bat as pager**: `git config core.pager` is set to `bat --style=changes`, providing syntax-highlighted diffs.

- **`dot doctor` checks 16 tools**: `git nvim tmux node pnpm fzf rg fd bat eza zoxide btop lazygit direnv stow gh claude`. It also scans `$HOME` (depth 3) for broken symlinks left by stow.

## Non-obvious Implementation Details

- **`dot init --server`** applies headless macOS settings via `systemsetup` and `launchctl`: disables system sleep, disables display sleep, enables SSH remote login, and disables Spotlight indexing. These are essential for an always-on Mac Mini.

- **Ghostty config only relevant on laptop**: the server is headless and renders no fonts or terminal UI. The Ghostty config is still stowed on the server (harmless), but only the laptop uses it.

- **`.p10k.zsh` lives in `home/`** and is version controlled. It is generated by running `p10k configure` but then committed so the prompt looks identical on every machine. It is sourced from `~/.p10k.zsh` (symlinked by stow).

- **tmux plugins installed on first launch** by pressing `Ctrl+A, I` (the TPM install shortcut). `dot init` clones TPM to `~/.tmux/plugins/tpm`, but individual plugins (sensible, resurrect, continuum) are fetched on first key press.

- **Stow is a single command**: `stow -d ~/dotfiles -t ~ home`. The `-d` flag sets the stow directory, `-t ~` sets the target, and `home` is the package. The `dot stow` wrapper adds `--restow` to prune stale symlinks.

- **`dot update` only bundles the shared Brewfile**, not `Brewfile.server`. Server-specific packages are only installed during initial `dot init --server`.

- **`dot backup <name>`** creates timestamped tarballs in `backups/` (gitignored). It archives configs from `$HOME` (the live symlink targets), not from the repo, so it captures the actual running state.

- **tmux prefix is `Ctrl+A`** (rebound from default `Ctrl+B`). Pane navigation uses vim-style `h/j/k/l` bindings.
